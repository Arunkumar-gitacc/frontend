# name: Frontend CI - Build & Trigger Deploy

# on:
#   push:
#     branches: ["main"]

# permissions:
#   contents: read

# jobs:
#   build:
#     runs-on: ubuntu-latest

#     steps:
#       # 1️⃣ Checkout frontend code
#       - name: Checkout code
#         uses: actions/checkout@v4

#       # 2️⃣ Login to Docker Hub
#       - name: Login to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKER_USERNAME }}
#           password: ${{ secrets.DOCKER_PASSWORD }}

#       # 3️⃣ Build frontend Docker image with commit SHA
#       - name: Build frontend image
#         run: |
#           docker build \
#             -t arunkumar885825/frontend:${{ github.sha }} \
#             -t arunkumar885825/frontend:latest \
#             .

#       # 4️⃣ Push frontend image
#       - name: Push frontend image
#         run: |
#           docker push arunkumar885825/frontend:${{ github.sha }}
#           docker push arunkumar885825/frontend:latest

#       # 5️⃣ Notify deployment repo (trigger CD)
#       - name: Trigger deployment pipeline
#         run: |
#           curl -X POST \
#             -H "Authorization: token ${{ secrets.DEPLOYMENT_REPO_TOKEN }}" \
#             -H "Accept: application/vnd.github.v3+json" \
#             https://api.github.com/repos/arunkumar-gitacc/deployment/dispatches \
#             -d '{
#               "event_type": "frontend_updated",
#               "client_payload": {
#                 "tag": "'"${{ github.sha }}"'"
#               }
#             }'
# name: Frontend CI - Build & Trigger Deploy

# on:
#   push:
#     branches: ["main"]

# permissions:
#   contents: read

# jobs:
#   build:
#     runs-on: ubuntu-latest

#     steps:
#       # 1️⃣ Checkout code
#       - name: Checkout code
#         uses: actions/checkout@v4

#       # 2️⃣ Login to Docker Hub
#       - name: Login to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKER_USERNAME }}
#           password: ${{ secrets.DOCKER_PASSWORD }}

#       # 3️⃣ Set short Git SHA
#       - name: Set image tag
#         run: echo "IMAGE_TAG=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

#       # 4️⃣ Build frontend image
#       - name: Build frontend image
#         run: |
#           docker build \
#             -t arunkumar885825/frontend:${IMAGE_TAG} \
#             -t arunkumar885825/frontend:latest \
#             .

#       # 5️⃣ Push frontend image
#       - name: Push frontend image
#         run: |
#           docker push arunkumar885825/frontend:${IMAGE_TAG}
#           docker push arunkumar885825/frontend:latest

#       # 6️⃣ Trigger deployment repo
#       - name: Trigger deployment pipeline
#         run: |
#           curl -X POST \
#             -H "Authorization: token ${{ secrets.DEPLOYMENT_REPO_TOKEN }}" \
#             -H "Accept: application/vnd.github.v3+json" \
#             https://api.github.com/repos/arunkumar-gitacc/deployment/dispatches \
#             -d '{
#               "event_type": "frontend_updated",
#               "client_payload": {
#                 "frontend_tag": "'"${IMAGE_TAG}"'"
#               }
#             }'


name: Build & Push Image (Auto Versioned)

permissions:
  contents: write  

on:
  push:
    branches:
      - dev
      - test
      - demo
      - prod

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout with full history (needed for tags)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2️⃣ Determine branch name
      - name: Set branch name
        run: |
          BRANCH=${GITHUB_REF##*/}
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

      # 3️⃣ Get latest semantic version for this branch
      - name: Get latest version
        run: |
          git fetch --tags

          LAST_TAG=$(git tag -l "${BRANCH}-v*" | sort -V | tail -n 1)

          if [ -z "$LAST_TAG" ]; then
            VERSION="v1.0.0"
          else
            BASE_VERSION=${LAST_TAG#*-v}
            IFS='.' read MAJOR MINOR PATCH <<< "$BASE_VERSION"
            PATCH=$((PATCH + 1))
            VERSION="v$MAJOR.$MINOR.$PATCH"
          fi

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "IMAGE_TAG=${BRANCH}-$VERSION" >> $GITHUB_ENV

      # 4️⃣ Create git tag (for tracking)
      - name: Create version tag
        run: |
          git tag "${IMAGE_TAG}"
          git push origin "${IMAGE_TAG}"

      # 5️⃣ Login to Docker Hub
      - name: Docker login
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login \
            -u "${{ secrets.DOCKER_USERNAME }}" \
            --password-stdin

      # 6. Build and Push Frontend Docker Image
      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/frontend:${{ env.IMAGE_TAG }}
            ${{ secrets.DOCKER_USERNAME }}/frontend:${{ env.BRANCH }}-latest

      # 7. Success output
      - name: Success Summary
        run: |
          echo "✅ Frontend Version Released: ${{ env.IMAGE_TAG }}"
          echo "✅ Docker Image: ${{ secrets.DOCKER_USERNAME }}/frontend:${{ env.IMAGE_TAG }}"

      # 8. Trigger EC2 Deployment
      - name: Trigger EC2 Deployment
        run: |
          curl -X POST "https://api.github.com/repos/Arunkumar-gitacc/deployment/dispatches" \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.DEPLOY_REPO_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -d "{\"event_type\":\"deploy\",\"client_payload\":{\"env\":\"${{ github.ref_name }}\"}}"