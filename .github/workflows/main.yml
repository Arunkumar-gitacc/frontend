# name: Frontend CI - Build & Trigger Deploy

# on:
#   push:
#     branches: ["main"]

# permissions:
#   contents: read

# jobs:
#   build:
#     runs-on: ubuntu-latest

#     steps:
#       # 1Ô∏è‚É£ Checkout frontend code
#       - name: Checkout code
#         uses: actions/checkout@v4

#       # 2Ô∏è‚É£ Login to Docker Hub
#       - name: Login to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKER_USERNAME }}
#           password: ${{ secrets.DOCKER_PASSWORD }}

#       # 3Ô∏è‚É£ Build frontend Docker image with commit SHA
#       - name: Build frontend image
#         run: |
#           docker build \
#             -t arunkumar885825/frontend:${{ github.sha }} \
#             -t arunkumar885825/frontend:latest \
#             .

#       # 4Ô∏è‚É£ Push frontend image
#       - name: Push frontend image
#         run: |
#           docker push arunkumar885825/frontend:${{ github.sha }}
#           docker push arunkumar885825/frontend:latest

#       # 5Ô∏è‚É£ Notify deployment repo (trigger CD)
#       - name: Trigger deployment pipeline
#         run: |
#           curl -X POST \
#             -H "Authorization: token ${{ secrets.DEPLOYMENT_REPO_TOKEN }}" \
#             -H "Accept: application/vnd.github.v3+json" \
#             https://api.github.com/repos/arunkumar-gitacc/deployment/dispatches \
#             -d '{
#               "event_type": "frontend_updated",
#               "client_payload": {
#                 "tag": "'"${{ github.sha }}"'"
#               }
#             }'
# name: Frontend CI - Build & Trigger Deploy (with SonarQube)

# on:
#   push:
#     branches:
#       - main

# permissions:
#   contents: read

# jobs:
#   build:
#     runs-on: ubuntu-latest

#     steps:
#       # -----------------------
#       # 1Ô∏è‚É£ CHECKOUT CODE
#       # -----------------------
#       - name: Checkout code
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0

#       # -----------------------
#       # 2Ô∏è‚É£ SETUP NODE (matches legacy projects)
#       # -----------------------
#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: 18

#       # -----------------------
#       # 3Ô∏è‚É£ INSTALL DEPENDENCIES (NO CODE CHANGE)
#       # -----------------------
#       - name: Install dependencies
#         run: npm ci --legacy-peer-deps

#       # -----------------------
#       # 4Ô∏è‚É£ RUN TESTS (OPTIONAL, SAFE)
#       # -----------------------
#       - name: Run tests
#         run: npm test -- --coverage
#         continue-on-error: true

#       # -----------------------
#       # 5Ô∏è‚É£ SONARQUBE SCAN
#       # -----------------------
#       - name: SonarQube Scan
#         uses: SonarSource/sonarqube-scan-action@v2
#         env:
#           SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#           SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

#       # -----------------------
#       # 6Ô∏è‚É£ SONARQUBE QUALITY GATE (BLOCK PIPELINE)
#       # -----------------------
#       - name: SonarQube Quality Gate
#         uses: SonarSource/sonarqube-quality-gate-action@v1
#         timeout-minutes: 5
#         env:
#           SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#           SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

#       # -----------------------
#       # 7Ô∏è‚É£ LOGIN TO DOCKER HUB
#       # -----------------------
#       - name: Login to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKER_USERNAME }}
#           password: ${{ secrets.DOCKER_PASSWORD }}

#       # -----------------------
#       # 8Ô∏è‚É£ SET IMAGE TAG (SHORT SHA)
#       # -----------------------
#       - name: Set image tag
#         run: echo "IMAGE_TAG=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

#       # -----------------------
#       # 9Ô∏è‚É£ BUILD FRONTEND IMAGE
#       # -----------------------
#       - name: Build frontend image
#         run: |
#           docker build \
#             -t arunkumar885825/frontend:${IMAGE_TAG} \
#             -t arunkumar885825/frontend:latest \
#             .

#       # -----------------------
#       # üîü PUSH FRONTEND IMAGE
#       # -----------------------
#       - name: Push frontend image
#         run: |
#           docker push arunkumar885825/frontend:${IMAGE_TAG}
#           docker push arunkumar885825/frontend:latest

#       # -----------------------
#       # 1Ô∏è‚É£1Ô∏è‚É£ TRIGGER DEPLOYMENT REPO
#       # -----------------------
#       - name: Trigger deployment pipeline
#         run: |
#           curl -X POST \
#             -H "Authorization: token ${{ secrets.DEPLOYMENT_REPO_TOKEN }}" \
#             -H "Accept: application/vnd.github.v3+json" \
#             https://api.github.com/repos/arunkumar-gitacc/deployment/dispatches \
#             -d '{
#               "event_type": "frontend_updated",
#               "client_payload": {
#                 "frontend_tag": "'"${IMAGE_TAG}"'"
#               }
#             }'

# name: Frontend CI + CD (uat / test / demo)

# on:
#   push:
#     branches:
#       - uat
#       - test
#       - demo
#     paths:
#       - "frontend/**"

# permissions:
#   contents: read

# jobs:
#   frontend-ci-cd:
#     runs-on: ubuntu-latest

#     steps:
#       # -----------------------
#       # CHECKOUT CODE
#       # -----------------------
#       - name: Checkout code
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0

#       # -----------------------
#       # SET BRANCH NAME
#       # -----------------------
#       - name: Set branch name
#         run: |
#           echo "BRANCH_NAME=${GITHUB_REF##*/}" >> $GITHUB_ENV

#       # -----------------------
#       # LOGIN TO DOCKER HUB
#       # -----------------------
#       - name: Login to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKER_USERNAME }}
#           password: ${{ secrets.DOCKER_PASSWORD }}

#       # -----------------------
#       # BUILD FRONTEND IMAGE
#       # -----------------------
#       - name: Build frontend image
#         run: |
#           docker build \
#             -t arunkumar885825/frontend:${BRANCH_NAME} \
#             ./frontend

#       # -----------------------
#       # PUSH FRONTEND IMAGE
#       # -----------------------
#       - name: Push frontend image
#         run: |
#           docker push arunkumar885825/frontend:${BRANCH_NAME}

#       # -----------------------
#       # CD - DEPLOY TO EC2
#       # -----------------------
#       - name: Deploy frontend (branch specific)
#         uses: appleboy/ssh-action@v1.0.3
#         with:
#           host: ${{ secrets.EC2_HOST }}
#           username: ${{ secrets.EC2_USER }}
#           key: ${{ secrets.EC2_SSH_KEY }}
#           script: |
#             set -e
#             echo "üöÄ Deploying FRONTEND for branch: ${BRANCH_NAME}"

#             cd /home/ec2-user/${BRANCH_NAME}
#             export BRANCH_NAME=${BRANCH_NAME}

#             docker compose pull frontend
#             docker compose up -d frontend








name: Build & Push Image (Auto Versioned)

permissions:
  contents: write  

on:
  push:
    branches:
      - dev
      - test
      - demo
      - prod

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout with full history (needed for tags)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Determine branch name
      - name: Set branch name
        run: |
          BRANCH=${GITHUB_REF##*/}
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

      # 3Ô∏è‚É£ Get latest semantic version for this branch
      - name: Get latest version
        run: |
          git fetch --tags

          LAST_TAG=$(git tag -l "${BRANCH}-v*" | sort -V | tail -n 1)

          if [ -z "$LAST_TAG" ]; then
            VERSION="v1.0.0"
          else
            BASE_VERSION=${LAST_TAG#*-v}
            IFS='.' read MAJOR MINOR PATCH <<< "$BASE_VERSION"
            PATCH=$((PATCH + 1))
            VERSION="v$MAJOR.$MINOR.$PATCH"
          fi

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "IMAGE_TAG=${BRANCH}-$VERSION" >> $GITHUB_ENV

      # 4Ô∏è‚É£ Create git tag (for tracking)
      - name: Create version tag
        run: |
          git tag "${IMAGE_TAG}"
          git push origin "${IMAGE_TAG}"

      # 5Ô∏è‚É£ Login to Docker Hub
      - name: Docker login
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login \
            -u "${{ secrets.DOCKER_USERNAME }}" \
            --password-stdin

      # 6. Build and Push Frontend Docker Image
      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/frontend:${{ env.IMAGE_TAG }}
            ${{ secrets.DOCKER_USERNAME }}/frontend:${{ env.BRANCH }}-latest

      # 7. Success output
      - name: Success Summary
        run: |
          echo "‚úÖ Frontend Version Released: ${{ env.IMAGE_TAG }}"
          echo "‚úÖ Docker Image: ${{ secrets.DOCKER_USERNAME }}/frontend:${{ env.IMAGE_TAG }}"

      # 8. Trigger EC2 Deployment
      - name: Trigger EC2 Deployment
        run: |
          curl -X POST "https://api.github.com/repos/Arunkumar-gitacc/deployment/dispatches" \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.DEPLOY_REPO_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -d "{\"event_type\":\"deploy\",\"client_payload\":{\"env\":\"${{ github.ref_name }}\"}}"