# name: Frontend CI - Build & Trigger Deploy

# on:
#   push:
#     branches: ["main"]

# permissions:
#   contents: read

# jobs:
#   build:
#     runs-on: ubuntu-latest

#     steps:
#       # 1ï¸âƒ£ Checkout frontend code
#       - name: Checkout code
#         uses: actions/checkout@v4

#       # 2ï¸âƒ£ Login to Docker Hub
#       - name: Login to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKER_USERNAME }}
#           password: ${{ secrets.DOCKER_PASSWORD }}

#       # 3ï¸âƒ£ Build frontend Docker image with commit SHA
#       - name: Build frontend image
#         run: |
#           docker build \
#             -t arunkumar885825/frontend:${{ github.sha }} \
#             -t arunkumar885825/frontend:latest \
#             .

#       # 4ï¸âƒ£ Push frontend image
#       - name: Push frontend image
#         run: |
#           docker push arunkumar885825/frontend:${{ github.sha }}
#           docker push arunkumar885825/frontend:latest

#       # 5ï¸âƒ£ Notify deployment repo (trigger CD)
#       - name: Trigger deployment pipeline
#         run: |
#           curl -X POST \
#             -H "Authorization: token ${{ secrets.DEPLOYMENT_REPO_TOKEN }}" \
#             -H "Accept: application/vnd.github.v3+json" \
#             https://api.github.com/repos/arunkumar-gitacc/deployment/dispatches \
#             -d '{
#               "event_type": "frontend_updated",
#               "client_payload": {
#                 "tag": "'"${{ github.sha }}"'"
#               }
#             }'
# name: Frontend CI - Build & Trigger Deploy

# on:
#   push:
#     branches: ["main"]

# permissions:
#   contents: read

# jobs:
#   build:
#     runs-on: ubuntu-latest

#     steps:
#       # 1ï¸âƒ£ Checkout code
#       - name: Checkout code
#         uses: actions/checkout@v4

#       # 2ï¸âƒ£ Login to Docker Hub
#       - name: Login to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKER_USERNAME }}
#           password: ${{ secrets.DOCKER_PASSWORD }}

#       # 3ï¸âƒ£ Set short Git SHA
#       - name: Set image tag
#         run: echo "IMAGE_TAG=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

#       # 4ï¸âƒ£ Build frontend image
#       - name: Build frontend image
#         run: |
#           docker build \
#             -t arunkumar885825/frontend:${IMAGE_TAG} \
#             -t arunkumar885825/frontend:latest \
#             .

#       # 5ï¸âƒ£ Push frontend image
#       - name: Push frontend image
#         run: |
#           docker push arunkumar885825/frontend:${IMAGE_TAG}
#           docker push arunkumar885825/frontend:latest

#       # 6ï¸âƒ£ Trigger deployment repo
#       - name: Trigger deployment pipeline
#         run: |
#           curl -X POST \
#             -H "Authorization: token ${{ secrets.DEPLOYMENT_REPO_TOKEN }}" \
#             -H "Accept: application/vnd.github.v3+json" \
#             https://api.github.com/repos/arunkumar-gitacc/deployment/dispatches \
#             -d '{
#               "event_type": "frontend_updated",
#               "client_payload": {
#                 "frontend_tag": "'"${IMAGE_TAG}"'"
#               }
#             }'
# name: Frontend CI - Build & Trigger Deploy (with SonarQube)

# on:
#   push:
#     branches:
#       - demo

# permissions:
#   contents: read

# jobs:
#   build:
#     runs-on: ubuntu-latest

#     steps:
#       # -----------------------
#       # 1ï¸âƒ£ CHECKOUT CODE
#       # -----------------------
#       - name: Checkout code
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 0

#       # -----------------------
#       # 2ï¸âƒ£ SETUP NODE (matches legacy projects)
#       # -----------------------
#       - name: Setup Node.js
#         uses: actions/setup-node@v4
#         with:
#           node-version: 18

#       # -----------------------
#       # 3ï¸âƒ£ INSTALL DEPENDENCIES (NO CODE CHANGE)
#       # -----------------------
#       - name: Install dependencies
#         run: npm ci --legacy-peer-deps

#       # -----------------------
#       # 4ï¸âƒ£ RUN TESTS (OPTIONAL, SAFE)
#       # -----------------------
#       - name: Run tests
#         run: npm test -- --coverage
#         continue-on-error: true

#       # -----------------------
#       # 5ï¸âƒ£ SONARQUBE SCAN
#       # -----------------------
#       - name: SonarQube Scan
#         uses: SonarSource/sonarqube-scan-action@v2
#         env:
#           SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#           SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

#       # -----------------------
#       # 6ï¸âƒ£ SONARQUBE QUALITY GATE (BLOCK PIPELINE)
#       # -----------------------
#       - name: SonarQube Quality Gate
#         uses: SonarSource/sonarqube-quality-gate-action@v1
#         timeout-minutes: 5
#         env:
#           SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#           SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}

#       # -----------------------
#       # 7ï¸âƒ£ LOGIN TO DOCKER HUB
#       # -----------------------
#       - name: Login to Docker Hub
#         uses: docker/login-action@v3
#         with:
#           username: ${{ secrets.DOCKER_USERNAME }}
#           password: ${{ secrets.DOCKER_PASSWORD }}

#       # -----------------------
#       # 8ï¸âƒ£ SET IMAGE TAG (SHORT SHA)
#       # -----------------------
#       - name: Set image tag
#         run: echo "IMAGE_TAG=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

#       # -----------------------
#       # 9ï¸âƒ£ BUILD FRONTEND IMAGE
#       # -----------------------
#       - name: Build frontend image
#         run: |
#           docker build \
#             -t arunkumar885825/frontend:${IMAGE_TAG} \
#             -t arunkumar885825/frontend:latest \
#             .

#       # -----------------------
#       # ðŸ”Ÿ PUSH FRONTEND IMAGE
#       # -----------------------
#       - name: Push frontend image
#         run: |
#           docker push arunkumar885825/frontend:${IMAGE_TAG}
#           docker push arunkumar885825/frontend:latest

#       # -----------------------
#       # 1ï¸âƒ£1ï¸âƒ£ TRIGGER DEPLOYMENT REPO
#       # -----------------------
#       - name: Trigger deployment pipeline
#         run: |
#           curl -X POST \
#             -H "Authorization: token ${{ secrets.DEPLOYMENT_REPO_TOKEN }}" \
#             -H "Accept: application/vnd.github.v3+json" \
#             https://api.github.com/repos/arunkumar-gitacc/deployment/dispatches \
#             -d '{
#               "event_type": "frontend_updated",
#               "client_payload": {
#                 "frontend_tag": "'"${IMAGE_TAG}"'"
#               }
#             }'


name: Build & Push Frontend Image (Auto Versioned)

permissions:
  contents: write

on:
  push:
    branches:
      - dev
      - test
      - demo
      - prod

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout with full history (needed for tags)
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. Determine branch name
      - name: Set branch name
        run: |
          BRANCH=${GITHUB_REF##*/}
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

      # 3. Get latest semantic version for this branch
      - name: Get latest version
        run: |
          git fetch --tags
          # Look for tags specifically for this branch: e.g., dev-v1.0.1
          LAST_TAG=$(git tag -l "${BRANCH}-v*" | sort -V | tail -n 1)

          if [ -z "$LAST_TAG" ]; then
            VERSION="v1.0.0"
          else
            # Extract version after the branch name and '-v'
            BASE_VERSION=${LAST_TAG#*-v}
            IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_VERSION"
            PATCH=$((PATCH + 1))
            VERSION="v$MAJOR.$MINOR.$PATCH"
          fi

          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "IMAGE_TAG=${BRANCH}-$VERSION" >> $GITHUB_ENV

      # 4. Create git tag (Configuring user is essential here)
      - name: Create and push git tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "${{ env.IMAGE_TAG }}"
          git push origin "${{ env.IMAGE_TAG }}"

      # 5. Login to Docker Hub
      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 6. Build and Push Frontend Docker Image
      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/frontend:${{ env.IMAGE_TAG }}
            ${{ secrets.DOCKER_USERNAME }}/frontend:${{ env.BRANCH }}-latest

      # 7. Success output
      - name: Success Summary
        run: |
          echo "âœ… Frontend Version Released: ${{ env.IMAGE_TAG }}"
          echo "âœ… Docker Image: ${{ secrets.DOCKER_USERNAME }}/frontend:${{ env.IMAGE_TAG }}"

      # 8. Trigger EC2 Deployment
      - name: Trigger EC2 Deployment
        run: |
          curl -X POST "https://api.github.com/repos/Arunkumar-gitacc/deployment/dispatches" \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.DEPLOY_REPO_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -d "{\"event_type\":\"deploy\",\"client_payload\":{\"env\":\"${{ github.ref_name }}\"}}"


